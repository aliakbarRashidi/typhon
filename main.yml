---
- hosts: all
  remote_user: root
  vars:
    redmine:
      database: redmine_db
      name: redminer
      pass: redminer
      dir: /var
      fulldir: /var/redmine-2.5.2
    gollum:
      fulldir: /var/gollum
    postgresql_users:
      - name: "{{ redmine.name }}"
        pass: "{{ redmine.pass }}"
    postgresql_databases:
      - name: "{{ redmine.database }}"
        owner: "{{ redmine.name }}"
    nginx_sites:
      - server:
          file_name: default
          server_name: "_"
          listen: 80
          return: 444
      - server:
          file_name: redmine
          server_name: redmine.example.com
          listen: 80
          root: "{{ redmine.fulldir }}/public"
          location1:
            name: /
            try_files: $uri $uri/index.html @passenger
          location2:
            name: "@passenger"
            passenger_enabled: "on"
      - server:
          file_name: gollum
          server_name: gollum.example.com
          listen: 80
          root: "{{ gollum.fulldir }}/public"
          location1:
            name: /
            root: "{{ gollum.fulldir }}/vendor/bundle/ruby/2.1.0/gems/gollum-3.0.0/lib/gollum/public/gollum/"
            try_files: $uri $uri/index.html @passenger
          location2:
            name: "@passenger"
            passenger_enabled: "on"
  roles:
  - role: base
  - role: nginx
  - role: postgresql
  - role: redmine
  - role: gollum
